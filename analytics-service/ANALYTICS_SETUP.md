# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Analytics Service

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ —Å Docker Compose

```bash
# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd expense-tracker

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Ollama –º–æ–¥–µ–ª—å (–∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)
docker-compose exec ollama ollama pull qwen2.5:0.5b

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
curl http://localhost:8081/health
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
curl http://localhost:8081/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Ollama
curl http://localhost:8081/api/v1/ollama/status

# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
curl -X POST http://localhost:8081/api/v1/analyze/trigger

# –°–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
curl http://localhost:8081/api/v1/scheduler/jobs
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
DATABASE_URL=postgres://user:pass@db:5432/expense_tracker
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_IDS=123456789,987654321

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
ANALYTICS_PORT=8081
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=qwen2.5:0.5b
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram

1. **–°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞** —á–µ—Ä–µ–∑ @BotFather
2. **–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω** –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `.env`
3. **–ü–æ–ª—É—á–∏—Ç–µ Chat ID** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
   ```bash
   # –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É, –∑–∞—Ç–µ–º:
   curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates"
   ```
4. **–î–æ–±–∞–≤—å—Ç–µ Chat ID** –≤ `TELEGRAM_CHAT_IDS`

## üìä API Endpoints

### Health Check
```bash
GET /health
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "service": "analytics-service",
  "status": "healthy",
  "ollama": true,
  "database": true,
  "last_check": "2024-01-15T20:00:00Z",
  "uptime": "2h30m15s",
  "version": "1.0.0"
}
```

### –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–∏–æ–¥–∞
```bash
GET /api/v1/analyze?period=day&days=7
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `period` - —Ç–∏–ø –ø–µ—Ä–∏–æ–¥–∞ (day/week/month)
- `days` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
```bash
POST /api/v1/analyze/trigger?period=day
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```bash
POST /api/v1/messages/send
Content-Type: application/json

{
  "chat_ids": [123456789],
  "type": "daily",
  "period": "day"
}
```

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π:**
- `daily` - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç
- `anomaly` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∞–Ω–æ–º–∞–ª–∏–∏
- `trend` - –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤

### –°—Ç–∞—Ç—É—Å Ollama
```bash
GET /api/v1/ollama/status
```

### –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
```bash
GET /api/v1/scheduler/jobs
```

## ü§ñ Ollama –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
# –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
docker-compose up -d ollama

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
curl http://localhost:11434/api/tags
```

### –†—É—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É Ollama
docker-compose exec ollama bash

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
ollama pull qwen2.5:0.5b

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
ollama list
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏

```bash
# –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å (–º–µ–Ω—å—à–µ —Ñ—É–Ω–∫—Ü–∏–π)
ollama pull qwen2.5:0.5b

# –ë–æ–ª–µ–µ –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å (–±–æ–ª—å—à–µ —Ñ—É–Ω–∫—Ü–∏–π)
ollama pull qwen2.5:1.5b

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# –ò–∑–º–µ–Ω–∏—Ç–µ OLLAMA_MODEL –≤ .env —Ñ–∞–π–ª–µ
```

## üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

| –í—Ä–µ–º—è | –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|--------|----------|
| 20:00 MSK | –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç | –ê–Ω–∞–ª–∏–∑ –¥–Ω—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ |
| –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π | –ü–æ–∏—Å–∫ –Ω–µ–æ–±—ã—á–Ω—ã—Ö —Ç—Ä–∞—Ç |
| –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 21:00 | –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ | –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ |
| –ö–∞–∂–¥—ã–π —á–∞—Å | Health check | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á
curl http://localhost:8081/api/v1/scheduler/jobs

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∑–∞–¥–∞—á–∏ (—á–µ—Ä–µ–∑ –∫–æ–¥)
# –í scheduler.go –¥–æ–±–∞–≤—å—Ç–µ:
_, err := s.cron.AddFunc("0 9 * * *", func() {
    // –í–∞—à–∞ –∑–∞–¥–∞—á–∞
})
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ analytics-service
docker-compose logs -f analytics

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Ollama
docker-compose logs -f ollama

# –í—Å–µ –ª–æ–≥–∏
docker-compose logs -f
```

### –ú–µ—Ç—Ä–∏–∫–∏

```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
curl http://localhost:8081/health

# –°—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
docker-compose exec db pg_isready

# –°—Ç–∞—Ç—É—Å Ollama
curl http://localhost:11434/api/tags
```

### –ê–ª–µ—Ä—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏:
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Ollama (fallback –Ω–∞ rule-based –ª–æ–≥–∏–∫—É)
- –û—à–∏–±–∫–∞—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –í—ã—Å–æ–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏—è—Ö –≤ —Ç—Ä–∞—Ç–∞—Ö (>2x —Å—Ä–µ–¥–Ω–µ–≥–æ)
- –ù–µ—É–¥–∞—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
cd analytics-service
go mod tidy

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
go test ./...

# –ó–∞–ø—É—Å–∫ —Å hot reload
air

# –°–±–æ—Ä–∫–∞
go build -o analytics-service ./cmd/analytics
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
analytics-service/
‚îú‚îÄ‚îÄ cmd/analytics/          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ analytics/         # –î–≤–∏–∂–æ–∫ –∞–Ω–∞–ª–∏–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ messaging/         # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ ollama/           # Ollama –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ scheduler/        # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ handlers/         # HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ types/            # –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ scripts/              # –°–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ Dockerfile
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤

1. **–†–∞—Å—à–∏—Ä—å—Ç–µ —Ç–∏–ø—ã** –≤ `internal/types/types.go`
2. **–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏–∫—É** –≤ `internal/analytics/engine.go`
3. **–°–æ–∑–¥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω—ã** –≤ `internal/messaging/generator.go`
4. **–î–æ–±–∞–≤—å—Ç–µ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** –≤ `internal/scheduler/scheduler.go`

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### Ollama –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats expense_ollama

# –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø–∞–º—è—Ç–∏
# –í docker-compose.yml:
deploy:
  resources:
    limits:
      memory: 4G
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
docker-compose exec analytics ping db

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
docker-compose exec analytics env | grep DATABASE
```

### Telegram —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getMe"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Chat ID
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates"
```

### –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ Ollama
# –í docker-compose.yml:
deploy:
  resources:
    limits:
      memory: 2G
      cpus: '1.0'
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Ollama

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GPU (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
docker-compose exec ollama ollama serve --gpu

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ç–æ–∫–æ–≤
export OLLAMA_NUM_PARALLEL=2
export OLLAMA_MAX_LOADED_MODELS=1
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
CREATE INDEX CONCURRENTLY idx_expenses_timestamp_operation 
ON expenses(timestamp, operation_type);

CREATE INDEX CONCURRENTLY idx_expenses_category_timestamp 
ON expenses(category_id, timestamp);
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ .env —Ñ–∞–π–ª
echo ".env" >> .gitignore

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
POSTGRES_PASSWORD=your_strong_password_here
JWT_SECRET=your_very_long_jwt_secret_here
```

### –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```yaml
# –í docker-compose.yml –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø:
services:
  ollama:
    networks:
      - internal
    # –ù–µ —ç–∫—Å–ø–æ–Ω–∏—Ä—É–π—Ç–µ –ø–æ—Ä—Ç –Ω–∞—Ä—É–∂—É
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: `docker-compose logs analytics`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å**: `curl http://localhost:8081/health`
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã**: `docker stats`
4. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã**: `docker-compose restart analytics ollama`

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- **Ollama –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**: –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏
- **–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **Telegram –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∏ Chat ID
- **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã Ollama
