# Analytics Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Ollama.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- **–õ–æ–∫–∞–ª—å–Ω—ã–π AI** —á–µ—Ä–µ–∑ Ollama (qwen2.5:0.5b)
- **Fallback –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Ollama
- **–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤** —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –¥–æ—Ö–æ–¥–æ–≤
- **–í—ã—è–≤–ª–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π** –≤ —Ç—Ä–∞—Ç–∞—Ö
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤** —ç–∫–æ–Ω–æ–º–∏–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã
- **–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã** –≤ 20:00 –ø–æ Moscow time
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–Ω–æ–º–∞–ª–∏—è—Ö** –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑** —Ç—Ä–µ–Ω–¥–æ–≤ –ø–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è–º
- **–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

### API Endpoints
- `GET /health` - Health check
- `GET /api/v1/analyze` - –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–∏–æ–¥–∞
- `POST /api/v1/analyze/trigger` - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
- `POST /api/v1/messages/send` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `GET /api/v1/scheduler/jobs` - –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
- `GET /api/v1/ollama/status` - –°—Ç–∞—Ç—É—Å Ollama

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
analytics-service/
‚îú‚îÄ‚îÄ cmd/analytics/          # Main application
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ analytics/         # Financial analysis engine
‚îÇ   ‚îú‚îÄ‚îÄ messaging/         # Telegram message generator
‚îÇ   ‚îú‚îÄ‚îÄ ollama/           # Ollama API client
‚îÇ   ‚îú‚îÄ‚îÄ scheduler/        # Cron job scheduler
‚îÇ   ‚îú‚îÄ‚îÄ handlers/         # HTTP handlers
‚îÇ   ‚îî‚îÄ‚îÄ types/            # Type definitions
‚îú‚îÄ‚îÄ scripts/              # Initialization scripts
‚îî‚îÄ‚îÄ Dockerfile
```

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Go 1.23** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫
- **Ollama** - –ª–æ–∫–∞–ª—å–Ω—ã–π AI (qwen2.5:0.5b)
- **go-cron** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **pgx** - PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
- **Chi** - HTTP —Ä–æ—É—Ç–µ—Ä
- **Zerolog** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö

### –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏
- –í—ã—è–≤–ª–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π (—Ç—Ä–∞—Ç—ã > 2x —Å—Ä–µ–¥–Ω–µ–≥–æ)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ —ç–∫–æ–Ω–æ–º–∏–∏
- –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

### AI-—É–ª—É—á—à–µ–Ω–∏—è
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ —Å –ø–æ–º–æ—â—å—é AI
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã

## ü§ñ Ollama –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ú–æ–¥–µ–ª—å: qwen2.5:0.5b
- **–†–∞–∑–º–µ—Ä**: ~0.5GB (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 2GB RAM)
- **–Ø–∑—ã–∫**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –•–æ—Ä–æ—à–µ–µ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–¥–∞—á

### Fallback –ª–æ–≥–∏–∫–∞
```go
if ollama.HealthCheck() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    message := ollama.GenerateDailyReport(analysis)
} else {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º rule-based –ª–æ–≥–∏–∫—É
    message := generateFallbackMessage(analysis)
}
```

## ‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
- **20:00 MSK** - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç
- **–ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π
- **–ö–∞–∂–¥—ã–π —á–∞—Å** - Health check

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
- **–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 21:00** - –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤

### –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∑–∞–¥–∞—á–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–∞–¥–∞—á
- –ì–∏–±–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ cron expressions

## üì± Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
1. **–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã**
   - –ë–∞–ª–∞–Ω—Å, —Ä–∞—Å—Ö–æ–¥—ã, –¥–æ—Ö–æ–¥—ã
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –¥–Ω–µ–º
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∏–Ω—Å–∞–π—Ç—ã

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–Ω–æ–º–∞–ª–∏—è—Ö**
   - –í—ã—Å–æ–∫–∏–µ —Ç—Ä–∞—Ç—ã (>2x —Å—Ä–µ–¥–Ω–µ–≥–æ)
   - –ù–µ–æ–±—ã—á–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   - –°–Ω–∏–∂–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤

3. **–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤**
   - –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
   - –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   - –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
```
üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç

üí∞ –ë–∞–ª–∞–Ω—Å: 1,250.50 ‚ÇΩ
üìâ –†–∞—Å—Ö–æ–¥—ã: 850.30 ‚ÇΩ
üìà –î–æ—Ö–æ–¥—ã: 2,100.80 ‚ÇΩ

üìà –†–∞—Å—Ö–æ–¥—ã: 15.2% (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ)
üìâ –î–æ—Ö–æ–¥—ã: 8.5% (—Å–Ω–∏–∂–µ–Ω–∏–µ)

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –£ –≤–∞—Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
‚Ä¢ –†–∞—Å—Ö–æ–¥—ã –≤—ã—Ä–æ—Å–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º–∏ —Ç—Ä–∞—Ç–∞–º–∏

üè∑Ô∏è –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç—ã: 450.20 ‚ÇΩ
‚Ä¢ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: 200.10 ‚ÇΩ
‚Ä¢ –ö–∞—Ñ–µ: 150.00 ‚ÇΩ

‚è∞ 20:00, 15 —è–Ω–≤–∞—Ä—è 2024
```

## üîç Health Checks

### –°–µ—Ä–≤–∏—Å —Å—Ç–∞—Ç—É—Å
```json
{
  "service": "analytics-service",
  "status": "healthy",
  "ollama": true,
  "database": true,
  "last_check": "2024-01-15T20:00:00Z",
  "uptime": "2h30m15s",
  "version": "1.0.0"
}
```

### –°—Ç–∞—Ç—É—Å—ã
- **healthy** - –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- **degraded** - Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback
- **unhealthy** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

## üöÄ –ó–∞–ø—É—Å–∫

### Docker Compose
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Ollama –º–æ–¥–µ–ª–∏
./analytics-service/scripts/init-ollama.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
curl http://localhost:8081/health
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
DATABASE_URL=postgres://user:pass@db:5432/expense_tracker
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_IDS=123456789,987654321

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
ANALYTICS_PORT=8081
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=qwen2.5:0.5b
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (JSON)
- –£—Ä–æ–≤–Ω–∏: DEBUG, INFO, WARN, ERROR
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ú–µ—Ç—Ä–∏–∫–∏
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
- –°—Ç–∞—Ç—É—Å Ollama —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ê–ª–µ—Ä—Ç—ã
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama
- –û—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—É–¥–∞—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –í—ã—Å–æ–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –≤ —Ç—Ä–∞—Ç–∞—Ö

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
internal/
‚îú‚îÄ‚îÄ analytics/engine.go     # –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ messaging/generator.go  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ ollama/client.go        # Ollama API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ scheduler/scheduler.go  # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
‚îú‚îÄ‚îÄ handlers/handlers.go    # HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îî‚îÄ‚îÄ types/types.go         # –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
1. –†–∞—Å—à–∏—Ä–∏—Ç—å `types.AnalysisResult`
2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `analytics.Engine`
3. –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
4. –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
go test ./...

# –¢–µ—Å—Ç —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
go test -cover ./...

# –ë–µ–Ω—á–º–∞—Ä–∫–∏
go test -bench=. ./...
```

## üéØ Roadmap

### –ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞–Ω—ã
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Ollama
- [ ] –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ –≤ PDF
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏
- [ ] –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ API
- [ ] –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- [ ] –ì–æ–ª–æ—Å–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker logs expense_analytics`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `curl http://localhost:8081/health`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Ollama: `curl http://localhost:11434/api/tags`
4. –°–æ–∑–¥–∞–π—Ç–µ issue —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
